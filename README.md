# Wizz Air METAR/TAF Monitor (GitHub Pages)

This repository provides a **static** (GitHub Pages) web UI that continuously monitors a list of aerodromes
(ICAO codes) and displays **METAR + TAF** with operational highlighting, alerting and prioritisation.

The design goal is OCC-style **triage**:
- what is bad **now** (METAR-driven),
- what will be bad **later** (TAF-driven),
- and which items are operational blockers (e.g. **ENG ICE OPS**).

---

## How it works (Architecture)

Because GitHub Pages is static and direct browser-to-AviationWeather requests often fail due to **CORS**,
the data is fetched server-side using **GitHub Actions**.

1. `airports.txt` contains ICAO codes (one per line).
2. A GitHub Actions workflow runs every 10 minutes:
   - reads `airports.txt`
   - downloads METAR and TAF from AviationWeather.gov
   - produces `data/latest.json`
3. GitHub Pages hosts:
   - `index.html`
   - `assets/app.js`, `assets/styles.css`
   - `data/latest.json` (generated by Actions)
4. The UI loads `data/latest.json` and renders the status table and Quick View.

---

## Data files

### `airports.txt`
One ICAO code per line, e.g.:
```
LHBP
EGGW
EPWA
```

### `data/latest.json`
Generated file written by the workflow. Expected structure:
```json
{
  "generatedAt": "2026-01-06T06:12:00Z",
  "stations": [
    {
      "icao": "EPPO",
      "iata": "POZ",
      "name": "Poznań–Ławica Airport",
      "metarRaw": "METAR EPPO ...",
      "tafRaw": "TAF EPPO ...",
      "metarAgeMin": 27,
      "tafAgeMin": 27
    }
  ]
}
```

Note: the UI is tolerant and also accepts some alternate field names (`station`, `metar`, `taf`, etc.).

---

## UI Overview

### 1) Sticky Critical Bar (tiles)
Top row tiles are **clickable filters**:
- **ENG ICE OPS** (pinned)  
  Condition: **METAR VIS ≤150 m AND FZFG**.  
  This is treated as an operational **stop-flag** and always sorts to the top.
  The tile shows the affected **IATA codes** in large, bold “chips”.
- **CRIT** (severityScore ≥ 70)
- **VIS ≤175** (worst of METAR/TAF)
- **TS** (thunderstorm signal present)

All tiles also render the affected **IATA codes** as readable chips (not only counts).
- **Reset** clears filters

Tiles always show counts for the **currently visible list** (after filters).

### 2) Filters
- **Text filter**: ICAO / IATA / airport name
- **Conditions**: visibility thresholds, RVR thresholds, Wx triggers, CIG<500, etc.
- **Alert filter**: OK / MED / HIGH / CRIT  
  Important: filtering **MED** shows **only MED** (CRIT is excluded).

### 3) Status table
Columns:
- ICAO / IATA / Airport name
- Alert (OK/MED/HIGH/CRIT)
- Visibility (m) + **trend pill**
- Low VIS bucket (tightest matched threshold)
- Triggers (tags)
- METAR age / TAF age
- METAR raw / TAF raw with highlight bubbles

### 4) Quick View (right drawer)
Open by clicking any row (or trigger tag).
Contains:
- Summary cards (Alert/Severity/Visibility/Worst VIS/RVR/Ceiling/Ages)
- Triggers tags (with source)
- METAR raw + decoded summary
- TAF raw + decoded summary
- **Copy briefing line** (clipboard)

Close with **Esc** or the close button.

---

## Highlighting rules

### Visibility thresholds (worst of METAR/TAF)
Highlighted in raw text, and bucketed in the UI:
- ≤800, ≤550, ≤500, ≤300, ≤250, ≤175, ≤150 m  
Each threshold has a dedicated color.

### RVR thresholds (min of METAR/TAF)
RVR tokens are detected from:
- `R27/0600`, `R27L/0300V0600`, etc.

Buckets:
- ≤500, ≤300, ≤200, ≤75 m  
Each bucket has a dedicated color.

### Ceiling (CIG<500)
Ceiling is derived from the lowest:
- `BKN###`, `OVC###`, or `VV###`  
Where `###` is hundreds of feet.

`CIG<500` means the lowest such layer is below 500 ft AGL.

### Weather triggers
The UI highlights and tags common hazards:
- TS, FZFG, FG, BR, SN/SHSN, RA/DZ

---

## Priority and sorting

When **Sort by priority** is enabled, the order is:

1. **ENG ICE OPS** (always pinned at the top)
2. **METAR priority score** (current conditions)
3. **TAF priority score** (forecast-only deterioration)
4. Combined severityScore as tie-break
5. ICAO

Rationale: METAR is “now”, so operationally it outranks “TAF-only” problems.

---

## Trend indicator (VIS)
The VIS column includes a small trend pill:
- `NEW` on first load (no previous value stored)
- `▼` when **METAR VIS** decreased vs the **previous METAR**
- `▲` when **METAR VIS** increased vs the **previous METAR**
- `•0` when unchanged

Important behaviour:
- The trend indicator updates **only when a NEW METAR arrives** (the `DDHHMMZ` group changes).
- If the dashboard refreshes or the data file is updated but the METAR timestamp is unchanged, the last trend symbol is retained.

Values are stored per station in `localStorage` (`prev METAR DDHHMMZ`, `prev METAR VIS`, `last trend`).

---

## Troubleshooting

### “0 stations” or “Loading…” forever
- Confirm `data/latest.json` exists in the GitHub Pages branch and is not empty.
- Run the GitHub Actions workflow and verify it commits `data/latest.json`.
- Ensure Actions has **Read and write** permissions:
  Settings → Actions → General → Workflow permissions → Read and write.
- Do not overwrite `data/latest.json` with a placeholder when uploading patches.

### Old UI after update
GitHub Pages can cache aggressively.
- Use a private window or hard refresh.
- This patch uses cache-busting query strings (e.g. `?v=23`).

---

## Patch contents
This patch updates only:
- `index.html`
- `assets/app.js`
- `assets/styles.css`
- `README.md`

It does **not** modify `airports.txt` or `data/` to avoid accidental “0 station” regressions.


## v20 UX Hotfixes (Layout + Readability + Parsing)
- **Tiles layout**: centered, equal-width responsive grid; improved contrast for tile numbers.
- **Sticky tiles**: tile bar stays pinned at the top while scrolling.
- **Controls readability**: search field has a sane max width; dropdowns use a dark theme with readable option colors (where supported by the browser).
- **Age auto-update**: METAR/TAF ages are recalculated **on every render** and the page triggers a lightweight refresh **every minute** (no refetch) so the minute counters keep moving while you watch the dashboard.
- **Age robustness**: if `metarAgeMin` / `tafAgeMin` are missing from `data/latest.json`, the UI computes them from the raw `DDHHMMZ` timestamp.
- **TAF highlight correctness**: visibility highlight no longer tags **TAF time groups** such as `0700/0708` (only standalone 4-digit vis values are highlighted).


## UX v28 adjustments (January 2026)
- **WOW tiles**: larger, equal-width tiles with a Wizz-inspired neon gradient border and improved number contrast for night shifts.
- **Sticky header restored**: tiles remain pinned at the top while scrolling.
- **Quick View drawer offset**: the right-side Quick View now starts **below** the sticky header (`--top-h`) so the header never covers drawer content.
- **Trend correctness**: VIS trend pill is based on **METAR** visibility and updates **only when a NEW METAR arrives** (timestamp `DDHHMMZ` changes). It no longer flips on mere UI refreshes or data republishing.
- **Age ticking without manual reload**: METAR/TAF age values are recomputed on every render, and the minute timer also refreshes age fields inside the Quick View drawer if it is open.

## UX v29 adjustments (January 2026)
- **Quick View scroll polish**: adds extra scroll room at the bottom of the drawer so the last "Decoded" panel never looks clipped (bottom border always visible).



## Responsive UI and TV Mode

The dashboard automatically adapts to the current screen size:

- **Mobile / Tablet**: the raw METAR/TAF columns are hidden to keep the table readable.
- **Desktop**: full table with raw METAR/TAF columns.

### TV Mode (large wall displays)

For OCC wall screens / large TVs you can enable **TV Mode** which increases:

- tile sizes and typography,
- airport code readability (ICAO/IATA),
- raw METAR/TAF readability.

How to toggle TV Mode:

- Click the **View** indicator/button (AUTO ↔ TV) next to the **Status table** title in the header, or
- Press **Shift+T**, or
- Double‑click the **Status table** title.

The chosen mode is saved in `localStorage` and will persist across reloads on the same device/browser.

## Stats page (/stat)

This patch adds a monitoring page at `stat/index.html`.

What it does:
- Polls `data/latest.json` every 60 seconds (browser/CDN only; does **not** increase AviationWeather (AWC) API load).
- Stores a short local history in the browser (LocalStorage) and plots:
  - Update intervals (changes in `generatedAt`)
  - Counts of ENG ICE OPS / CRIT / VIS≤175 / TS
  - METAR/TAF completeness (missing data)

Notes:
- The history is kept per-device/browser. For a wall TV, it will build up its own local history after opening `/stat/`.
- If you want server-side history shared across devices, you can extend the GitHub Actions workflow to append a `data/history.json` file each run.

### Recommended server-side refresh frequency

- GitHub Actions scheduled workflows have a minimum interval of **5 minutes**.
- AviationWeather (AWC) Data API warns that rate limiting may apply for frequent requests and recommends using cache files for large/global pulls.
- For this monitor (~159 stations): **every 10 minutes** is conservative and typically sufficient.
- Use **every 5 minutes** only if you specifically need faster detection of SPECI and short-lived phenomena.

## Auto-refresh behaviour (important)

The dashboard is designed to be **hands-off**: you should not need to press browser refresh.

- The GitHub Action updates `data/latest.json` on its schedule (default: **every 10 minutes**).
- The **main dashboard** (root `index.html`) **polls** `data/latest.json` every **60 seconds**.
  - If `generatedAt` is unchanged, it does **not rerender the table** (to avoid scroll jumps); it only
    updates the **METAR/TAF age** fields.
  - If `generatedAt` changed, it **reloads and rerenders** stations, counters, priorities, tiles, and Quick View.
- The **Trend** (improving / worsening) logic updates **only when a new METAR arrives** (i.e. when `generatedAt` changes and the METAR observation time group changes).

This pattern keeps the UI stable on an OCC wallboard while still reflecting new data quickly.



## Airport change history (stat page)

The `/stat/` page includes an **Airport change history** section that records, per ICAO:

- METAR VIS changes (worsened / improved)
- METAR RVR(min) changes
- METAR weather-group changes (e.g. FG/FZFG/TS/SN/RA)
- TAF worst-visibility changes (forecast worsening / improving)
- TAF RVR(min) changes
- TAF weather-group changes

Notes:
- Events are recorded **only** when a **new dataset** arrives (when `generatedAt` changes).
- The change history is stored in **your browser localStorage** (per-device/per-browser). It does not sync between devices.
- Each airport keeps up to the last **30** events to keep storage size safe.

