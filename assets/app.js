/*
  Front-end renderer for data/latest.json (generated by GitHub Actions).

  UX goals (based on your reference screenshot):
  - compact status table
  - filter bar (ICAO/IATA/name)
  - “All conditions” selector
  - “Sort by priority” toggle
  - explicit columns (Alert / VIS / flags / triggers / ages / raw)
*/

const DATA_URL = 'data/latest.json';
const dataUrl = () => `${DATA_URL}?ts=${Date.now()}`;
const STATUS_URL = 'data/status.json';
const REFRESH_MS = 10 * 60 * 1000;

const $ = (sel) => document.querySelector(sel);
const byId = (id) => document.getElementById(id);

function escapeHtml(s){
  return (s ?? '').replace(/[&<>"']/g, (c) => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[c]));
}

function formatGeneratedAt(s){
  if(!s) return '—';
  const t = Date.parse(s);
  if(Number.isNaN(t)) return '—';
  return new Date(t).toLocaleString();
}


function clamp(n, a, b){
  return Math.max(a, Math.min(b, n));
}

function levelFromScore(score){
  if (score >= 70) return { label: 'CRIT', cls: 'pill pill--crit' };
  if (score >= 45) return { label: 'HIGH', cls: 'pill pill--high' };
  if (score >= 20) return { label: 'MED',  cls: 'pill pill--med' };
  return { label: 'OK',   cls: 'pill pill--ok' };
}

function hasEngineIcingStopFlag(item){
  // High-priority operational flag (user-defined): VIS ≤ 150 m AND FZFG present.
  const hazards = Array.isArray(item.hazards) ? item.hazards : [];
  const worstVis = visNumber(item.worst_visibility_m ?? item.visibility_m ?? null);
  return (worstVis != null && worstVis <= 150) && hazards.includes('FZFG');
}

function displayScore(item){
  // Keep the server-provided score, but allow a local UI override for special stop-flags.
  const base = Math.round(item.severityScore ?? 0);
  if(hasEngineIcingStopFlag(item)) return Math.max(base, 95);
  return base;
}

function parseDdhhmmZ(raw){
  // Finds the first DDHHMMZ group.
  if (!raw) return null;
  const m = raw.match(/\b(\d{2})(\d{2})(\d{2})Z\b/);
  if(!m) return null;
  return { dd: Number(m[1]), hh: Number(m[2]), mm: Number(m[3]) };
}

function obsTimeUtcFromGroup(ddhhmm, baseIso){
  // METAR/TAF has day-of-month (DD) without month/year.
  // Build a UTC Date close to base by trying month-1, month, month+1 and picking the closest.
  if(!ddhhmm || !baseIso) return null;
  const base = new Date(baseIso);
  if(Number.isNaN(base.getTime())) return null;

  const y = base.getUTCFullYear();
  const m = base.getUTCMonth();
  const candidates = [m-1, m, m+1].map(mm => {
    const d = new Date(Date.UTC(y, mm, ddhhmm.dd, ddhhmm.hh, ddhhmm.mm, 0));
    return d;
  });
  let best = candidates[0];
  let bestAbs = Math.abs(best.getTime() - base.getTime());
  for(const c of candidates.slice(1)){
    const abs = Math.abs(c.getTime() - base.getTime());
    if(abs < bestAbs){ best = c; bestAbs = abs; }
  }
  return best;
}

function ageMinutes(raw, baseIso){
  // “How many minutes ago was it issued/observed” (relative to *now* by default).
  const g = new Date(baseIso);
  if(Number.isNaN(g.getTime())) return null;
  const group = parseDdhhmmZ(raw);
  const t = obsTimeUtcFromGroup(group, baseIso);
  if(!t) return null;
  const mins = Math.round((g.getTime() - t.getTime()) / 60000);
  if(!Number.isFinite(mins)) return null;
  // If something is weird (e.g. older than ~2 days), still show but clamp negatives.
  return clamp(mins, 0, 9999);
}

function visNumber(m){
  if(m == null) return null;
  if(m === 9999) return 10000;
  return m;
}

function buildTriggers(item){
  const tags = [];
  const hazards = Array.isArray(item.hazards) ? item.hazards : [];
  const has = (x) => hazards.includes(x);

  // RVR (minimum across METAR + TAF if available)
  const rvrMin = Number.isFinite(item.rvrMin) ? item.rvrMin : null;
  if(rvrMin != null){
    if(rvrMin <= 75) tags.push({ t: 'RVR≤75', key: 'rvr75' });
    else if(rvrMin <= 200) tags.push({ t: 'RVR≤200', key: 'rvr200' });
    else if(rvrMin <= 300) tags.push({ t: 'RVR≤300', key: 'rvr300' });
    else if(rvrMin <= 500) tags.push({ t: 'RVR≤500', key: 'rvr500' });
  }

  const worstVis = item.worst_visibility_m ?? item.visibility_m ?? null;
  const vis = visNumber(worstVis);

  if(vis != null){
    if(vis <= 150) tags.push({ t: 'VIS≤150', key: 'vis150' });
    else if(vis <= 175) tags.push({ t: 'VIS≤175', key: 'vis175' });
    else if(vis <= 250) tags.push({ t: 'VIS≤250', key: 'vis250' });
    else if(vis <= 300) tags.push({ t: 'VIS≤300', key: 'vis300' });
    else if(vis <= 500) tags.push({ t: 'VIS≤500', key: 'vis500' });
    else if(vis <= 550) tags.push({ t: 'VIS≤550', key: 'vis550' });
    else if(vis <= 800) tags.push({ t: 'VIS≤800', key: 'vis800' });
  }

  if(has('FZFG')) tags.push({ t: 'FZFG', key: 'fzfg' });

  // Engine operations stop-flag (highest priority)
  if(hasEngineIcingStopFlag(item)) tags.unshift({ t: 'ENG ICE OPS', key: 'eng' });

  // Fog / mist
  if(has('FG') || has('BR')) tags.push({ t: has('FG') ? 'FG' : 'BR', key: 'fog' });

  // TS group
  if(hazards.some(h => /^TS/.test(h))) tags.push({ t: 'TS', key: 'ts' });

  // Snow group
  if(hazards.some(h => ['SN','SHSN','BLSN','PL','SG'].includes(h))) tags.push({ t: 'SN', key: 'snow' });

  // Rain group
  if(hazards.some(h => ['RA','+RA','SHRA','DZ','FZDZ','FZRA'].includes(h))) tags.push({ t: 'RA', key: 'rain' });

  // Low ceiling (METAR only from server calc)
  if(item.ceiling_ft != null){
    if(item.ceiling_ft < 500) tags.push({ t: 'CIG<500', key: 'cig' });
    else if(item.ceiling_ft < 1000) tags.push({ t: 'CIG<1000', key: 'cig' });
  }

  // Deduplicate by key
  const seen = new Set();
  return tags.filter(x => (seen.has(x.t) ? false : (seen.add(x.t), true)));
}

function extractRvrValuesMeters(raw){
  if(!raw) return [];
  // Examples: R17/0600, R17L/0600U, R09/0400V0800, R27/P1500
  const re = /\bR\d{2}[LRC]?\/[PM]?\d{4}(?:V[PM]?\d{4})?[UDN]?\b/g;
  const tokens = raw.match(re) || [];
  const values = [];
  for(const tok of tokens){
    // Pull all 4-digit chunks after the slash and optional V
    const nums = tok.match(/\d{4}/g) || [];
    for(const n of nums){
      const v = parseInt(n, 10);
      if(Number.isFinite(v)) values.push(v);
    }
  }
  return values;
}

function computeRvrMin(item){
  const vals = [...extractRvrValuesMeters(item.metarRaw), ...extractRvrValuesMeters(item.tafRaw)];
  if(!vals.length) return null;
  return Math.min(...vals);
}

function rvrClassFromMin(v){
  if(v == null) return null;
  if(v <= 75) return 'hl-rvr-75';
  if(v <= 200) return 'hl-rvr-200';
  if(v <= 300) return 'hl-rvr-300';
  if(v <= 500) return 'hl-rvr-500';
  return null;
}

function parseSmToMeters(token){
  // Handles: 1/2SM, 2SM, 1 1/2SM (as two tokens typically), P6SM
  const t = token.toUpperCase();
  if(!t.endsWith('SM')) return null;
  if(t.startsWith('P')) return null; // greater than
  const core = t.slice(0, -2);
  // fraction a/b
  if(/^\d+\/\d+$/.test(core)){
    const [a,b] = core.split('/').map(x => parseInt(x,10));
    if(!b) return null;
    const miles = a / b;
    return miles * 1609.344;
  }
  // decimal / integer
  if(/^\d+(?:\.\d+)?$/.test(core)){
    const miles = parseFloat(core);
    if(!Number.isFinite(miles)) return null;
    return miles * 1609.344;
  }
  return null;
}

function visClassFromMeters(m){
  if(m == null) return null;
  if(m <= 150) return 'hl-vis-150';
  if(m <= 175) return 'hl-vis-175';
  if(m <= 250) return 'hl-vis-250';
  if(m <= 300) return 'hl-vis-300';
  if(m <= 500) return 'hl-vis-500';
  if(m <= 550) return 'hl-vis-550';
  if(m <= 800) return 'hl-vis-800';
  return null;
}

function lowVisLabelFromMeters(m){
  if(m == null) return null;
  if(m <= 150) return '≤150';
  if(m <= 175) return '≤175';
  if(m <= 250) return '≤250';
  if(m <= 300) return '≤300';
  if(m <= 500) return '≤500';
  if(m <= 550) return '≤550';
  if(m <= 800) return '≤800';
  return null;
}

function wxClassFromToken(token){
  const t0 = token.toUpperCase();
  const t = t0.replace(/^[-+]/, '');
  const t2 = t.startsWith('VC') ? t.slice(2) : t;

  // Thunderstorm first (e.g., -TSRA)
  if(/TS/.test(t2)) return 'hl-ts';

  // Fog / mist group
  if(/FZFG/.test(t2) || /\bFG\b/.test(t2) || t2 === 'BR' || /BR/.test(t2) || /MIFG|BCFG|PRFG|VCFG/.test(t2)) return 'hl-fog';

  // Snow / ice pellets
  if(/SN|SHSN|BLSN|DRSN|SG|PL/.test(t2)) return 'hl-snow';

  // Rain / drizzle / freezing
  if(/RA|SHRA|DZ|FZRA|FZDZ/.test(t2)) return 'hl-rain';

  return null;
}

function highlightRaw(raw, ctx = {}){
  // ctx: { engice: boolean }
  if(!raw) return '<span class="muted">—</span>';
  const parts = String(raw).split(/(\s+)/);
  return parts.map((p) => {
    if(!p) return '';
    if(/^\s+$/.test(p)) return p;

    // RVR tokens
    if(/^R\d{2}[LRC]?\/[PM]?\d{4}(?:V[PM]?\d{4})?[UDN]?$/i.test(p)){
      const nums = (p.match(/\d{4}/g) || []).map(x => parseInt(x,10)).filter(n => Number.isFinite(n));
      const minv = nums.length ? Math.min(...nums) : null;
      const cls = rvrClassFromMin(minv);
      if(cls){
        return `<span class="hl ${cls}" data-cat="rvr">${escapeHtml(p)}</span>`;
      }
      return escapeHtml(p);
    }


    // Visibility tokens in meters (4 digits)
    if(/^\d{4}$/.test(p)){
      const v = parseInt(p, 10);
      if(Number.isFinite(v)){
        const cls = visClassFromMeters(v);
        if(cls) return `<span class="hl ${cls}" data-cat="vis">${escapeHtml(p)}</span>`;
      }
      return escapeHtml(p);
    }


    // Ceiling tokens (METAR/TAF): highlight very low ceiling that drives CIG<500
    // (BKN/OVC/VV below 005 => <500 ft AGL)
    if(/^(BKN|OVC|VV)\d{3}$/i.test(p)){
      const n = parseInt(p.slice(-3), 10); // hundreds of feet
      if(Number.isFinite(n) && n < 5){
        return `<span class="hl hl-cig-500" data-cat="cig">${escapeHtml(p)}</span>`;
      }
    }

    // Visibility tokens in statute miles
    const sm = parseSmToMeters(p);
    if(sm != null){
      const cls = visClassFromMeters(sm);
      if(cls) return `<span class="hl ${cls}" data-cat="vis">${escapeHtml(p)}</span>`;
      return escapeHtml(p);
    }

    // Weather phenomena tokens
    if(ctx.engice && /FZFG/i.test(p)){
      return `<span class="hl hl-engice" data-cat="eng">${escapeHtml(p)}</span>`;
    }

    const wxCls = wxClassFromToken(p);
    if(wxCls){
      return `<span class="hl ${wxCls}" data-cat="wx">${escapeHtml(p)}</span>`;
    }

    return escapeHtml(p);
  }).join('');
}

function alertMatch(item, desired){
  if(!desired || desired === 'all') return true;
  const score = displayScore(item);
  const lbl = levelFromScore(score).label.toLowerCase();
  return lbl === desired;
}

function conditionMatch(item, cond){
  if(cond === 'all') return true;
  const hazards = Array.isArray(item.hazards) ? item.hazards : [];
  const worstVis = visNumber(item.worst_visibility_m ?? item.visibility_m ?? null);
  const score = displayScore(item);
  const rvrMin = Number.isFinite(item.rvrMin) ? item.rvrMin : null;

  switch(cond){
    case 'alerts': return score >= 20;
    case 'engice': return hasEngineIcingStopFlag(item);
    case 'vis800': return worstVis != null && worstVis <= 800;
    case 'vis550': return worstVis != null && worstVis <= 550;
    case 'vis500': return worstVis != null && worstVis <= 500;
    case 'vis300': return worstVis != null && worstVis <= 300;
    case 'vis250': return worstVis != null && worstVis <= 250;
    case 'vis175': return worstVis != null && worstVis <= 175;
    case 'vis150': return worstVis != null && worstVis <= 150;
    case 'rvr500': return rvrMin != null && rvrMin <= 500;
    case 'rvr300': return rvrMin != null && rvrMin <= 300;
    case 'rvr200': return rvrMin != null && rvrMin <= 200;
    case 'rvr75':  return rvrMin != null && rvrMin <= 75;
    case 'fog': return hazards.includes('FG') || hazards.includes('BR') || hazards.includes('FZFG');
    case 'snow': return hazards.some(h => ['SN','SHSN','BLSN','PL','SG'].includes(h));
    case 'rain': return hazards.some(h => ['RA','+RA','SHRA','DZ','FZDZ','FZRA'].includes(h));
    case 'ts': return hazards.some(h => /^TS/.test(h));
    default: return true;
  }
}

function renderRow(item, nowIso){
  const icao = escapeHtml(item.icao);
  const iata = item.iata ? escapeHtml(item.iata) : '';
  const name = item.name ? escapeHtml(item.name) : '';

  const score = displayScore(item);
  const lvl = levelFromScore(score);

  const metarAge = ageMinutes(item.metarRaw, nowIso);
  const tafAge = ageMinutes(item.tafRaw, nowIso);

  // Table VIS shows METAR visibility in meters (as in your reference screenshot).
  const visM = visNumber(item.visibility_m ?? null);
  const prevVis = (state.prevVis && state.prevVis[item.icao] != null) ? Number(state.prevVis[item.icao]) : null;
  const deltaVis = (visM != null && prevVis != null && Number.isFinite(prevVis)) ? (visM - prevVis) : null;
  let trendPill = '';
  if(visM != null){
    if(prevVis == null || !Number.isFinite(prevVis)){
      trendPill = `<span class="trendPill trendPill--new" title="No previous sample">NEW</span>`;
    }else if(deltaVis > 0){
      trendPill = `<span class="trendPill trendPill--up" title="+${escapeHtml(String(deltaVis))} m">▲${escapeHtml(String(deltaVis))}</span>`;
    }else if(deltaVis < 0){
      trendPill = `<span class="trendPill trendPill--down" title="${escapeHtml(String(deltaVis))} m">▼${escapeHtml(String(Math.abs(deltaVis)))}</span>`;
    }else{
      trendPill = `<span class="trendPill trendPill--flat" title="0 m">•0</span>`;
    }
  }
  const worstVis = visNumber(item.worst_visibility_m ?? item.visibility_m ?? null);
  const lowVisLabel = lowVisLabelFromMeters(worstVis);
  const lowVisCls = visClassFromMeters(worstVis);

  const triggers = buildTriggers(item);
  const engice = hasEngineIcingStopFlag(item);

  return `
    <tr class="row" data-icao="${icao}">
      <td>
        <div class="airport">
          <div class="airport__codes">
            <span class="airport__icao mono">${icao}</span>
            ${iata ? `<span class="airport__iata mono">${iata}</span>` : ''}
            <button class="openBtn" type="button" title="Open Quick View" aria-label="Open Quick View">›</button>
          </div>
          ${name ? `<div class="airport__name">${name}</div>` : ''}
        </div>
      </td>

      <td><span class="${lvl.cls}">${lvl.label}</span></td>

      <td class="mono"><span class="num">${visM == null ? '—' : visM}</span>${trendPill ? ` ${trendPill}` : ''}</td>

      <td>${lowVisLabel ? `<span class="hl ${lowVisCls}" data-cat="vis">VIS${lowVisLabel}</span>` : '<span class="muted">—</span>'}</td>

      <td>
        <div class="triggers">
          ${triggers.length
            ? triggers.map(t => {
              const k = (t.key || 'wx');
              const cat = k.startsWith('vis') ? 'vis' : (k.startsWith('rvr') ? 'rvr' : (k === 'cig' ? 'cig' : k));
              return `<span class="tag tag--${cat}">${escapeHtml(t.t)}</span>`;
            }).join('')
            : `<span class="muted">—</span>`
          }
        </div>
      </td>

      <td>${metarAge == null ? '<span class="muted">—</span>' : `<span class="${metarAge <= 20 ? 'age age--fresh' : (metarAge <= 60 ? 'age age--warn' : 'age age--stale')}">${metarAge}m</span>`}</td>
      <td>${tafAge == null ? '<span class="muted">—</span>' : `<span class="${tafAge <= 60 ? 'age age--fresh' : (tafAge <= 180 ? 'age age--warn' : 'age age--stale')}">${tafAge}m</span>`}</td>

      <td><div class="raw">${item.metarRaw ? highlightRaw(item.metarRaw, { engice }) : '<span class="muted">No METAR</span>'}</div></td>
      <td><div class="raw">${item.tafRaw ? highlightRaw(item.tafRaw, { engice }) : '<span class="muted">No TAF</span>'}</div></td>
    </tr>
  `;
}

let state = {
  generatedAt: null,
  stations: [],
  stats: null,
  errors: [],
};

// Local persistence for simple trend indicators (client-side only).
const LS_KEY_VIS = 'wzz_prev_vis_v1';

function loadPrevVis(){
  try{
    const raw = localStorage.getItem(LS_KEY_VIS);
    if(!raw) return {};
    const obj = JSON.parse(raw);
    return (obj && typeof obj === 'object') ? obj : {};
  }catch(_e){
    return {};
  }
}

function savePrevVis(map){
  try{
    localStorage.setItem(LS_KEY_VIS, JSON.stringify(map || {}));
  }catch(_e){
    // ignore
  }
}

// Initialize trend baseline
state.prevVis = loadPrevVis();
state.drawerItem = null;

// Drawer helpers
function openDrawer(item){
  if(!item) return;
  const drawer = byId('drawer');
  if(!drawer) return;

  state.drawerItem = item;

  const title = byId('dTitle');
  const sub = byId('dSub');
  const sum = byId('dSummary');
  const met = byId('dMetar');
  const taf = byId('dTaf');

  const icao = item.icao || '—';
  const iata = item.iata || '';
  const name = item.name || '';

  const score = displayScore(item);
  const lvl = levelFromScore(score);

  const nowIso = new Date().toISOString();
  const metAge = ageMinutes(item.metarRaw, nowIso);
  const tafAge = ageMinutes(item.tafRaw, nowIso);

  const vis = visNumber(item.visibility_m ?? null);
  const worstVis = visNumber(item.worst_visibility_m ?? item.visibility_m ?? null);
  const rvrMin = Number.isFinite(item.rvrMin) ? item.rvrMin : null;
  const cig = (item.ceiling_ft != null) ? item.ceiling_ft : null;

  const trigs = buildTriggers(item);

  if(title) title.textContent = `${icao}${iata ? '  •  ' + iata : ''}`;
  if(sub) sub.textContent = name ? name : '—';

  const mkAge = (x) => (x == null ? '—' : `${x}m`);
  const mkNum = (x, suf='') => (x == null ? '—' : `${x}${suf}`);

  if(sum){
    sum.innerHTML = [
      `<div class="kv"><div class="kv__k">Alert</div><div class="kv__v"><span class="${lvl.cls}">${lvl.label}</span></div></div>`,
      `<div class="kv"><div class="kv__k">Severity</div><div class="kv__v mono">${score}</div></div>`,
      `<div class="kv"><div class="kv__k">Visibility</div><div class="kv__v mono">${mkNum(vis,' m')}</div></div>`,
      `<div class="kv"><div class="kv__k">Worst VIS (METAR/TAF)</div><div class="kv__v mono">${mkNum(worstVis,' m')}</div></div>`,
      `<div class="kv"><div class="kv__k">RVR (min)</div><div class="kv__v mono">${mkNum(rvrMin,' m')}</div></div>`,
      `<div class="kv"><div class="kv__k">Ceiling</div><div class="kv__v mono">${mkNum(cig,' ft')}</div></div>`,
      `<div class="kv"><div class="kv__k">METAR age</div><div class="kv__v mono">${mkAge(metAge)}</div></div>`,
      `<div class="kv"><div class="kv__k">TAF age</div><div class="kv__v mono">${mkAge(tafAge)}</div></div>`,
      `<div class="kv" style="grid-column:1 / -1;"><div class="kv__k">Triggers</div><div class="kv__v">${trigs.length ? trigs.map(t => {
        const k = (t.key || 'wx');
        const cat = k.startsWith('vis') ? 'vis' : (k.startsWith('rvr') ? 'rvr' : (k === 'cig' ? 'cig' : k));
        return `<span class="tag tag--${cat}">${escapeHtml(t.t)}</span>`;
      }).join(' ') : '<span class="muted">—</span>'}</div></div>`,
    ].join('');
  }

  const engice = hasEngineIcingStopFlag(item);
  if(met) met.innerHTML = item.metarRaw ? highlightRaw(item.metarRaw, { engice }) : '<span class="muted">No METAR</span>';
  if(taf) taf.innerHTML = item.tafRaw ? highlightRaw(item.tafRaw, { engice }) : '<span class="muted">No TAF</span>';

  drawer.classList.add('is-open');
  drawer.setAttribute('aria-hidden', 'false');
}

function closeDrawer(){
  const drawer = byId('drawer');
  if(!drawer) return;
  drawer.classList.remove('is-open');
  drawer.setAttribute('aria-hidden', 'true');
}

function updateCriticalBarFromDom(){
  const tbody = $('#tbody');
  if(!tbody) return;
  const trs = Array.from(tbody.querySelectorAll('tr[data-icao]'));
  const hasTagText = (tr, txt) => {
    const tags = tr.querySelectorAll('.tag');
    for(const t of tags){ if((t.textContent || '').trim() === txt) return true; }
    return false;
  };

  const eng = trs.filter(tr => tr.querySelector('.tag--eng') || hasTagText(tr, 'ENG ICE OPS')).length;
  const crit = trs.filter(tr => tr.querySelector('.pill--crit')).length;
  const vis175 = trs.filter(tr => {
    const tags = Array.from(tr.querySelectorAll('.tag--vis'));
    return tags.some(t => /^VIS≤(150|175)$/.test((t.textContent||'').trim()));
  }).length;
  const ts = trs.filter(tr => tr.querySelector('.tag--ts') || hasTagText(tr, 'TS')).length;

  const set = (id, val) => { const el = $('#' + id); if(el) el.textContent = String(val); };
  set('cbEngCount', eng);
  set('cbCritCount', crit);
  set('cbVis175Count', vis175);
  set('cbTsCount', ts);
}


function applyFilters(){
  const text = ($('#filterText').value || '').trim().toUpperCase();
  const cond = $('#condSel').value;
  const alertSel = ($('#alertSel') ? $('#alertSel').value : 'all');
  const sortPriority = $('#sortPriority').checked;

  let rows = state.stations.slice();

  if(text){
    rows = rows.filter(s => {
      const hay = [s.icao, s.iata, s.name].filter(Boolean).join(' ').toUpperCase();
      return hay.includes(text);
    });
  }

  rows = rows.filter(s => conditionMatch(s, cond));
  rows = rows.filter(s => alertMatch(s, alertSel));

  if(sortPriority){
    rows.sort((a,b) => {
      const ae = hasEngineIcingStopFlag(a);
      const be = hasEngineIcingStopFlag(b);
      // Engine icing stop-flag is always pinned to the very top.
      if(ae && !be) return -1;
      if(!ae && be) return 1;
      return (displayScore(b) - displayScore(a)) || String(a.icao).localeCompare(String(b.icao));
    });
  }else{
    rows.sort((a,b) => String(a.icao).localeCompare(String(b.icao)));
  }

  return rows;
}

function render(){
  const tbody = $('#tbody');
  const msg = $('#statusMsg');
  const diag = $('#diag');

  // Recompute ages against current time even if the underlying JSON did not change.
  const nowIso = new Date().toISOString();

  const rows = applyFilters();

  // NOTE: Critical Bar counters are updated after table HTML is rendered (DOM-based),
  // so they always reflect exactly what you see on screen.
  const sc = $('#stationsCount'); if(sc) sc.textContent = String((state.stations||[]).length);

  // Prepare trend persistence for next render
  const nextVisMap = {};
  state.stations.forEach(s => {
    const v = visNumber(s.visibility_m ?? null);
    if(v != null) nextVisMap[s.icao] = v;
  });

  // Status + diagnostics
  const stats = state.stats || null;
  const errList = Array.isArray(state.errors) ? state.errors : [];

  if(stats && (Object.keys(stats).length || errList.length)){
    const parts = [];
    if(stats.icaoCount != null) parts.push(`<b>ICAO</b>: <span class="mono">${escapeHtml(String(stats.icaoCount))}</span>`);
    if(stats.metarReturned != null) parts.push(`<b>METAR</b>: <span class="mono">${escapeHtml(String(stats.metarReturned))}</span>`);
    if(stats.tafReturned != null) parts.push(`<b>TAF</b>: <span class="mono">${escapeHtml(String(stats.tafReturned))}</span>`);
    if(stats.missingMetar != null) parts.push(`<b>Missing METAR</b>: <span class="mono">${escapeHtml(String(stats.missingMetar))}</span>`);
    if(stats.missingTaf != null) parts.push(`<b>Missing TAF</b>: <span class="mono">${escapeHtml(String(stats.missingTaf))}</span>`);

    let html = parts.join(' &nbsp; | &nbsp; ');
    if(errList.length){
      html += `<div style="margin-top:6px" class="err"><b>Errors</b>: ${escapeHtml(errList.join(' | '))}</div>`;
    }
    diag.hidden = false;
    diag.innerHTML = html;
  }else{
    diag.hidden = true;
    diag.innerHTML = '';
  }

  if(state.stations.length === 0){
    msg.textContent = '0 stations loaded. This usually means the GitHub Action did not generate data/latest.json yet (or could not push). Open data/status.json in the repo for the exact error, and ensure you have a workflow under .github/workflows and Actions has Read & write permissions.';
  }else{
    msg.textContent = '';
  }

  tbody.innerHTML = rows.length
    ? rows.map(r => renderRow(r, nowIso)).join('')
    : '<tr><td colspan="9" class="muted">No matching rows.</td></tr>';

  // Update critical tiles now that the visible rows exist.
  updateCriticalBarFromDom();
  // Extra safety: in some browsers innerHTML updates may render on next frame.
  requestAnimationFrame(updateCriticalBarFromDom);

  // Persist baseline for VIS trend arrows
  savePrevVis(nextVisMap);
  state.prevVis = nextVisMap;
}

async function load(){
  const tbody = $('#tbody');
  try{
    // Load main data
    const res = await fetch(`${DATA_URL}?t=${Date.now()}`, { cache: 'no-store' });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();

    state.generatedAt = data.generatedAt || null;
    state.stations = Array.isArray(data.stations) ? data.stations.map((s) => {
      const rvrMin = computeRvrMin(s);
      return {
        ...s,
        rvrMin,
      };
    }) : [];
    state.stats = data.stats || null;
    state.errors = Array.isArray(data.errors) ? data.errors : [];

    // Also try to load status.json (more reliable diagnostics if latest.json stayed as placeholder)
    try{
      const sres = await fetch(`${STATUS_URL}?t=${Date.now()}`, { cache: 'no-store' });
      if(sres.ok){
        const sdata = await sres.json();
        if(!state.stats && sdata.stats) state.stats = sdata.stats;
        if((!state.errors || !state.errors.length) && Array.isArray(sdata.errors)) state.errors = sdata.errors;
      }
    }catch{ /* ignore */ }

    $('#lastUpdate').textContent = formatGeneratedAt(state.generatedAt);
    const sc = $('#stationsCount');
    if(sc) sc.textContent = String((state.stations||[]).length);

    render();
  }catch(e){
    tbody.innerHTML = `<tr><td colspan="9" class="muted">Data load error: ${escapeHtml(String(e))}</td></tr>`;
  }
}

let timer = null;
function startTimer(){
  stopTimer();
  timer = setInterval(load, REFRESH_MS);
}
function stopTimer(){
  if(timer) clearInterval(timer);
  timer = null;
}

// Wire UI
$('#refreshBtn').addEventListener('click', () => load());
$('#autoRefresh').addEventListener('change', (e) => e.target.checked ? startTimer() : stopTimer());

['filterText','condSel','alertSel','sortPriority'].forEach(id => {
  const el = $('#' + id);
  if(!el) return;
  el.addEventListener('input', render);
  el.addEventListener('change', render);
});

// Critical Bar quick filters
function setFilters(opts){
  const o = opts || {};
  const ft = $('#filterText'); if(ft && o.text != null) ft.value = o.text;
  const cs = $('#condSel'); if(cs && o.cond != null) cs.value = o.cond;
  const al = $('#alertSel'); if(al && o.alert != null) al.value = o.alert;
  const sp = $('#sortPriority'); if(sp && o.sort != null) sp.checked = !!o.sort;
  render();
}

(function(){
  const el = $('#cbEng'); if(el) el.addEventListener('click', () => setFilters({ cond: 'engice', alert: 'all', sort: true }));
})();
(function(){
  const el = $('#cbCrit'); if(el) el.addEventListener('click', () => setFilters({ cond: 'all', alert: 'crit', sort: true }));
})();
(function(){
  const el = $('#cbVis175'); if(el) el.addEventListener('click', () => setFilters({ cond: 'vis175', alert: 'all', sort: true }));
})();
(function(){
  const el = $('#cbTs'); if(el) el.addEventListener('click', () => setFilters({ cond: 'ts', alert: 'all', sort: true }));
})();
(function(){
  const el = $('#cbReset'); if(el) el.addEventListener('click', () => setFilters({ text: '', cond: 'all', alert: 'all', sort: true }));
})();

// Row click -> drawer
(function(){
  const tb = $('#tbody');
  if(!tb) return;
  tb.addEventListener('click', (e) => {
    const tr = e.target.closest('tr[data-icao]');
    if(!tr) return;
    const icao = tr.getAttribute('data-icao');
    const item = (state.stations || []).find(s => s.icao === icao);
    openDrawer(item);
  });
})();

// Drawer close actions
(function(){
  const x = byId('drawerClose'); if(x) x.addEventListener('click', closeDrawer);
  const b = byId('drawerBackdrop'); if(b) b.addEventListener('click', closeDrawer);
})();
document.addEventListener('keydown', (e) => { if(e.key === 'Escape') closeDrawer(); });

// Copy briefing line
(function(){
  const btn = $('#copyBrief');
  if(!btn) return;
  btn.addEventListener('click', async () => {
    const item = state.drawerItem;
    if(!item) return;

    const nowIso = new Date().toISOString();
    const score = displayScore(item);
    const lvl = levelFromScore(score);
    const vis = visNumber(item.visibility_m ?? null);
    const worstVis = visNumber(item.worst_visibility_m ?? item.visibility_m ?? null);
    const rvrMin = Number.isFinite(item.rvrMin) ? item.rvrMin : null;
    const cig = (item.ceiling_ft != null) ? item.ceiling_ft : null;
    const metAge = ageMinutes(item.metarRaw, nowIso);
    const tafAge = ageMinutes(item.tafRaw, nowIso);

    const trigs = buildTriggers(item).map(t => t.t).join(', ');
    const line = [
      `${item.icao}${item.iata ? `(${item.iata})` : ''}`,
      `ALERT=${lvl.label}`,
      `SCORE=${score}`,
      `VIS=${vis != null ? vis+'m' : '—'}`,
      `WVIS=${worstVis != null ? worstVis+'m' : '—'}`,
      `RVRmin=${rvrMin != null ? rvrMin+'m' : '—'}`,
      `CIG=${cig != null ? cig+'ft' : '—'}`,
      `METARage=${metAge != null ? metAge+'m' : '—'}`,
      `TAFage=${tafAge != null ? tafAge+'m' : '—'}`,
      trigs ? `TRIG=${trigs}` : ''
    ].filter(Boolean).join(' | ');

    try{
      await navigator.clipboard.writeText(line);
      const msg = $('#statusMsg');
      if(msg){
        msg.textContent = 'Briefing line copied to clipboard.';
        setTimeout(() => { if(msg.textContent === 'Briefing line copied to clipboard.') msg.textContent = ''; }, 1800);
      }
    }catch(_e){
      const ta = document.createElement('textarea');
      ta.value = line;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
    }
  });
})();


load();
startTimer();

// Keep the “age” columns current even between 10‑minute data refreshes.
setInterval(() => {
  if(state && Array.isArray(state.stations) && state.stations.length) render();
}, 60 * 1000);