/*
  Front-end renderer for data/latest.json (generated by GitHub Actions).

  UX goals (based on your reference screenshot):
  - compact status table
  - filter bar (ICAO/IATA/name)
  - “All conditions” selector
  - “Sort by priority” toggle
  - explicit columns (Alert / VIS / flags / triggers / ages / raw)
*/

const DATA_URL = 'data/latest.json';
const REFRESH_MS = 10 * 60 * 1000;

const $ = (sel) => document.querySelector(sel);

function escapeHtml(s){
  return (s ?? '').replace(/[&<>"']/g, (c) => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[c]));
}

function clamp(n, a, b){
  return Math.max(a, Math.min(b, n));
}

function levelFromScore(score){
  if (score >= 70) return { label: 'CRIT', cls: 'pill pill--crit' };
  if (score >= 45) return { label: 'HIGH', cls: 'pill pill--high' };
  if (score >= 20) return { label: 'MED',  cls: 'pill pill--med' };
  return { label: 'OK',   cls: 'pill pill--ok' };
}

function parseDdhhmmZ(raw){
  // Finds the first DDHHMMZ group.
  if (!raw) return null;
  const m = raw.match(/\b(\d{2})(\d{2})(\d{2})Z\b/);
  if(!m) return null;
  return { dd: Number(m[1]), hh: Number(m[2]), mm: Number(m[3]) };
}

function obsTimeUtcFromGroup(ddhhmm, baseIso){
  // METAR/TAF has day-of-month (DD) without month/year.
  // Build a UTC Date close to base by trying month-1, month, month+1 and picking the closest.
  if(!ddhhmm || !baseIso) return null;
  const base = new Date(baseIso);
  if(Number.isNaN(base.getTime())) return null;

  const y = base.getUTCFullYear();
  const m = base.getUTCMonth();
  const candidates = [m-1, m, m+1].map(mm => {
    const d = new Date(Date.UTC(y, mm, ddhhmm.dd, ddhhmm.hh, ddhhmm.mm, 0));
    return d;
  });
  let best = candidates[0];
  let bestAbs = Math.abs(best.getTime() - base.getTime());
  for(const c of candidates.slice(1)){
    const abs = Math.abs(c.getTime() - base.getTime());
    if(abs < bestAbs){ best = c; bestAbs = abs; }
  }
  return best;
}

function ageMinutes(raw, baseIso){
  // “How many minutes ago was it issued/observed” (relative to *now* by default).
  const g = new Date(baseIso);
  if(Number.isNaN(g.getTime())) return null;
  const group = parseDdhhmmZ(raw);
  const t = obsTimeUtcFromGroup(group, baseIso);
  if(!t) return null;
  const mins = Math.round((g.getTime() - t.getTime()) / 60000);
  if(!Number.isFinite(mins)) return null;
  // If something is weird (e.g. older than ~2 days), still show but clamp negatives.
  return clamp(mins, 0, 9999);
}

function visNumber(m){
  if(m == null) return null;
  if(m === 9999) return 10000;
  return m;
}

function buildTriggers(item){
  const tags = [];
  const hazards = Array.isArray(item.hazards) ? item.hazards : [];
  const has = (x) => hazards.includes(x);

  const worstVis = item.worst_visibility_m ?? item.visibility_m ?? null;
  const vis = visNumber(worstVis);

  if(vis != null && vis <= 150) tags.push({ t: 'VIS≤150', key: 'vis150' });
  else if(vis != null && vis <= 800) tags.push({ t: 'VIS≤800', key: 'vis800' });

  if(has('FZFG')) tags.push({ t: 'FZFG', key: 'fzfg' });

  // Fog / mist
  if(has('FG') || has('BR')) tags.push({ t: has('FG') ? 'FG' : 'BR', key: 'fog' });

  // TS group
  if(hazards.some(h => /^TS/.test(h))) tags.push({ t: 'TS', key: 'ts' });

  // Snow group
  if(hazards.some(h => ['SN','SHSN','BLSN','PL','SG'].includes(h))) tags.push({ t: 'SN', key: 'snow' });

  // Rain group
  if(hazards.some(h => ['RA','+RA','SHRA','DZ','FZDZ','FZRA'].includes(h))) tags.push({ t: 'RA', key: 'rain' });

  // Low ceiling (METAR only from server calc)
  if(item.ceiling_ft != null){
    if(item.ceiling_ft < 500) tags.push({ t: 'CIG<500', key: 'cig' });
    else if(item.ceiling_ft < 1000) tags.push({ t: 'CIG<1000', key: 'cig' });
  }

  // Deduplicate by key
  const seen = new Set();
  return tags.filter(x => (seen.has(x.t) ? false : (seen.add(x.t), true)));
}

function conditionMatch(item, cond){
  if(cond === 'all') return true;
  const hazards = Array.isArray(item.hazards) ? item.hazards : [];
  const worstVis = visNumber(item.worst_visibility_m ?? item.visibility_m ?? null);
  const score = item.severityScore ?? 0;

  switch(cond){
    case 'alerts': return score >= 20;
    case 'vis800': return worstVis != null && worstVis <= 800;
    case 'vis150': return worstVis != null && worstVis <= 150;
    case 'fzfg': return hazards.includes('FZFG');
    case 'fog': return hazards.includes('FG') || hazards.includes('BR') || hazards.includes('FZFG');
    case 'snow': return hazards.some(h => ['SN','SHSN','BLSN','PL','SG'].includes(h));
    case 'rain': return hazards.some(h => ['RA','+RA','SHRA','DZ','FZDZ','FZRA'].includes(h));
    case 'ts': return hazards.some(h => /^TS/.test(h));
    default: return true;
  }
}

function renderRow(item, nowIso){
  const icao = escapeHtml(item.icao);
  const iata = item.iata ? escapeHtml(item.iata) : '';
  const name = item.name ? escapeHtml(item.name) : '';

  const score = Math.round(item.severityScore ?? 0);
  const lvl = levelFromScore(score);

  const metarAge = ageMinutes(item.metarRaw, nowIso);
  const tafAge = ageMinutes(item.tafRaw, nowIso);

  // Table VIS shows METAR visibility in meters (as in your reference screenshot).
  const visM = visNumber(item.visibility_m ?? null);

  const hasFzfg = (item.hazards || []).includes('FZFG');
  const lowVis150 = (visNumber(item.worst_visibility_m ?? item.visibility_m ?? null) ?? 99999) <= 150;

  const triggers = buildTriggers(item);

  return `
    <tr>
      <td>
        <div class="airport">
          <div class="airport__codes">
            <span class="airport__icao mono">${icao}</span>
            ${iata ? `<span class="airport__iata mono">${iata}</span>` : ''}
          </div>
          ${name ? `<div class="airport__name">${name}</div>` : ''}
        </div>
      </td>

      <td><span class="${lvl.cls}">${lvl.label}</span></td>

      <td class="mono"><span class="num">${visM == null ? '—' : visM}</span></td>

      <td><span class="yn ${hasFzfg ? 'yn--yes' : 'yn--no'}">${hasFzfg ? 'YES' : '—'}</span></td>

      <td><span class="yn ${lowVis150 ? 'yn--yes' : 'yn--no'}">${lowVis150 ? 'YES' : '—'}</span></td>

      <td>
        <div class="triggers">
          ${triggers.length
            ? triggers.map(t => `<span class="tag">${escapeHtml(t.t)}</span>`).join('')
            : `<span class="muted">—</span>`
          }
        </div>
      </td>

      <td>${metarAge == null ? '<span class="muted">—</span>' : `<span class="age">${metarAge}m</span>`}</td>
      <td>${tafAge == null ? '<span class="muted">—</span>' : `<span class="age">${tafAge}m</span>`}</td>

      <td><div class="raw">${item.metarHtml ?? '<span class="muted">No METAR</span>'}</div></td>
      <td><div class="raw">${item.tafHtml ?? '<span class="muted">No TAF</span>'}</div></td>
    </tr>
  `;
}

let state = {
  generatedAt: null,
  stations: [],
};

function applyFilters(){
  const text = ($('#filterText').value || '').trim().toUpperCase();
  const cond = $('#condSel').value;
  const sortPriority = $('#sortPriority').checked;

  let rows = state.stations.slice();

  if(text){
    rows = rows.filter(s => {
      const hay = [s.icao, s.iata, s.name].filter(Boolean).join(' ').toUpperCase();
      return hay.includes(text);
    });
  }

  rows = rows.filter(s => conditionMatch(s, cond));

  if(sortPriority){
    rows.sort((a,b) => (b.severityScore ?? 0) - (a.severityScore ?? 0) || String(a.icao).localeCompare(String(b.icao)));
  }else{
    rows.sort((a,b) => String(a.icao).localeCompare(String(b.icao)));
  }

  return rows;
}

function render(){
  const tbody = $('#tbody');
  const msg = $('#statusMsg');

  // Recompute ages against current time even if the underlying JSON did not change.
  const nowIso = new Date().toISOString();

  const rows = applyFilters();

  if(state.stations.length === 0){
    msg.textContent = 'If you see 0 monitored stations, the workflow did not write data/latest.json yet. Check Actions logs and ensure Actions has read/write permission for the repository.';
  }else{
    msg.textContent = '';
  }

  tbody.innerHTML = rows.length
    ? rows.map(r => renderRow(r, nowIso)).join('')
    : '<tr><td colspan="10" class="muted">No matching rows.</td></tr>';
}

async function load(){
  const tbody = $('#tbody');
  try{
    const res = await fetch(`${DATA_URL}?t=${Date.now()}`, { cache: 'no-store' });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();

    state.generatedAt = data.generatedAt || null;
    state.stations = Array.isArray(data.stations) ? data.stations : [];

    $('#lastUpdate').textContent = state.generatedAt ? new Date(state.generatedAt).toLocaleString() : '—';

    render();
  }catch(e){
    tbody.innerHTML = `<tr><td colspan="10" class="muted">Data load error: ${escapeHtml(String(e))}</td></tr>`;
  }
}

let timer = null;
function startTimer(){
  stopTimer();
  timer = setInterval(load, REFRESH_MS);
}
function stopTimer(){
  if(timer) clearInterval(timer);
  timer = null;
}

// Wire UI
$('#refreshBtn').addEventListener('click', () => load());
$('#autoRefresh').addEventListener('change', (e) => e.target.checked ? startTimer() : stopTimer());

['filterText','condSel','scopeSel','sortPriority'].forEach(id => {
  const el = $('#' + id);
  if(!el) return;
  el.addEventListener('input', render);
  el.addEventListener('change', render);
});

load();
startTimer();

// Keep the “age” columns current even between 10‑minute data refreshes.
setInterval(() => {
  if(state && Array.isArray(state.stations) && state.stations.length) render();
}, 60 * 1000);
